from telegram import Update, InlineKeyboardMarkup
from telegram.ext import ContextTypes, CallbackQueryHandler, CommandHandler
from database import get_db, User
from keyboards import TradingKeyboards
from datetime import datetime

class StartHandler:
    @staticmethod
    async def start(update: Update, context: ContextTypes.DEFAULT_TYPE):
        """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /start"""
        user = update.effective_user
        db = next(get_db())
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        db_user = db.query(User).filter(User.telegram_id == user.id).first()
        
        if not db_user:
            # –°–æ–∑–¥–∞–µ–º –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            db_user = User(
                telegram_id=user.id,
                username=user.username,
                first_name=user.first_name,
                last_name=user.last_name,
                balance=2000.0,
                registered_at=datetime.utcnow(),
                last_active=datetime.utcnow()
            )
            db.add(db_user)
            db.commit()
            
            welcome_text = f"""
üéÆ –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ Trading Game!

üìä –í—ã –ø–æ–ª—É—á–∏–ª–∏ –Ω–∞—á–∞–ª—å–Ω—ã–π –±–∞–ª–∞–Ω—Å: $2,000

üî• –î–æ—Å—Ç—É–ø–Ω—ã–µ –º–æ–Ω–µ—Ç—ã:
‚Ä¢ BTC/USDT
‚Ä¢ ETH/USDT  
‚Ä¢ BNB/USDT

‚ö° –ü–ª–µ—á–∏: 2x, 5x, 10x
‚ö†Ô∏è –í–Ω–∏–º–∞–Ω–∏–µ: –†–∏—Å–∫ –ª–∏–∫–≤–∏–¥–∞—Ü–∏–∏ –ø—Ä–∏ —É–±—ã—Ç–∫–µ >100%

üìà –ù–∞—á–Ω–∏—Ç–µ —Ç–æ—Ä–≥–æ–≤–∞—Ç—å –ø—Ä—è–º–æ —Å–µ–π—á–∞—Å!
            """
        else:
            # –û–±–Ω–æ–≤–ª—è–µ–º –≤—Ä–µ–º—è –ø–æ—Å–ª–µ–¥–Ω–µ–π –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
            db_user.last_active = datetime.utcnow()
            db.commit()
            
            welcome_text = f"""
üëã –° –≤–æ–∑–≤—Ä–∞—â–µ–Ω–∏–µ–º, {db_user.first_name}!

üí∞ –í–∞—à –±–∞–ª–∞–Ω—Å: ${db_user.balance:.2f}
üìä –û–±—â–∏–π PnL: ${db_user.total_profit:.2f}
üìà –í–∏–Ω—Ä–µ–π—Ç: {db_user.win_rate:.1f}%

üèÜ –í–∞—à —Ä–∞–Ω–≥: #{db_user.rank}

–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ:
            """
        
        keyboard = TradingKeyboards.main_menu()
        
        if update.callback_query:
            await update.callback_query.edit_message_text(
                text=welcome_text,
                reply_markup=keyboard
            )
        else:
            await update.message.reply_text(
                text=welcome_text,
                reply_markup=keyboard
            )
    
    @staticmethod
    async def help_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
        """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /help"""
        help_text = """
üìö –ü–æ–º–æ—â—å –ø–æ Trading Game:

üìà –ö–∞–∫ —Ç–æ—Ä–≥–æ–≤–∞—Ç—å:
1. –ù–∞–∂–º–∏—Ç–µ "–¢–æ—Ä–≥–æ–≤–∞—Ç—å"
2. –í—ã–±–µ—Ä–∏—Ç–µ LONG/SHORT
3. –í—ã–±–µ—Ä–∏—Ç–µ –º–æ–Ω–µ—Ç—É
4. –í—ã–±–µ—Ä–∏—Ç–µ –ø–ª–µ—á–æ (2x, 5x, 10x)
5. –£–∫–∞–∂–∏—Ç–µ —Å—É–º–º—É

‚ö° –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:
‚Ä¢ –ù–∞—á–∞–ª—å–Ω—ã–π –±–∞–ª–∞–Ω—Å: $2,000
‚Ä¢ –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Å–¥–µ–ª–∫–∞: $10
‚Ä¢ –ú–∞–∫—Å. –ø–æ–∑–∏—Ü–∏–π: 5 –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ
‚Ä¢ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –ª–∏–∫–≤–∏–¥–∞—Ü–∏—è –ø—Ä–∏ —É–±—ã—Ç–∫–µ >100%

üìä –§—É–Ω–∫—Ü–∏–∏:
‚Ä¢ –†–µ–∞–ª—å–Ω—ã–µ –≥—Ä–∞—Ñ–∏–∫–∏
‚Ä¢ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ SL/TP
‚Ä¢ –ò—Å—Ç–æ—Ä–∏—è —Å–¥–µ–ª–æ–∫
‚Ä¢ –†–µ–π—Ç–∏–Ω–≥ –∏–≥—Ä–æ–∫–æ–≤

‚ö†Ô∏è –†–∏—Å–∫–∏:
‚Ä¢ –í—ã—Å–æ–∫–æ–µ –ø–ª–µ—á–æ = –≤—ã—Å–æ–∫–∏–π —Ä–∏—Å–∫
‚Ä¢ –í–æ–∑–º–æ–∂–Ω–∞ –ø–æ–ª–Ω–∞—è –ø–æ—Ç–µ—Ä—è —Å—Ä–µ–¥—Å—Ç–≤
‚Ä¢ –≠—Ç–æ —Å–∏–º—É–ª—è—Ç–æ—Ä, —Ç–æ—Ä–≥—É–π—Ç–µ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ!

üÜò –ü–æ–¥–¥–µ—Ä–∂–∫–∞: @–≤–∞—à_–∞–∫–∫–∞—É–Ω—Ç
        """
        
        await update.message.reply_text(help_text)
    
    @staticmethod
    async def balance_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
        """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /balance"""
        user = update.effective_user
        db = next(get_db())
        
        db_user = db.query(User).filter(User.telegram_id == user.id).first()
        
        if db_user:
            balance_text = f"""
üí∞ –í–∞—à –±–∞–ª–∞–Ω—Å: ${db_user.balance:.2f}

üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:
‚Ä¢ –û–±—â–∏–π PnL: ${db_user.total_profit:.2f}
‚Ä¢ –í—Å–µ–≥–æ —Å–¥–µ–ª–æ–∫: {db_user.total_trades}
‚Ä¢ –í–∏–Ω—Ä–µ–π—Ç: {db_user.win_rate:.1f}%
‚Ä¢ –†–∞–Ω–≥: #{db_user.rank}

üí° –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ /trade –¥–ª—è –Ω–∞—á–∞–ª–∞ —Ç–æ—Ä–≥–æ–≤–ª–∏
            """
        else:
            balance_text = "–í—ã –Ω–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω—ã. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ /start"
        
        await update.message.reply_text(balance_text)
    
    @staticmethod
    def get_handlers():
        """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–æ–º–∞–Ω–¥"""
        return [
            CommandHandler('start', StartHandler.start),
            CommandHandler('help', StartHandler.help_command),
            CommandHandler('balance', StartHandler.balance_command),
            CallbackQueryHandler(StartHandler.start, pattern='^back_main$')
        ]
