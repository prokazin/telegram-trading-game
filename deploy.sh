#!/bin/bash

# Ð¡ÐºÑ€Ð¸Ð¿Ñ‚ Ñ€Ð°Ð·Ð²ÐµÑ€Ñ‚Ñ‹Ð²Ð°Ð½Ð¸Ñ Trading Game Bot

set -e

echo "ðŸš€ ÐÐ°Ñ‡Ð°Ð»Ð¾ Ñ€Ð°Ð·Ð²ÐµÑ€Ñ‚Ñ‹Ð²Ð°Ð½Ð¸Ñ Trading Game Bot..."

# ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð¿ÐµÑ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ñ… Ð¾ÐºÑ€ÑƒÐ¶ÐµÐ½Ð¸Ñ
if [ -z "$BOT_TOKEN" ]; then
    echo "âŒ ÐžÑˆÐ¸Ð±ÐºÐ°: BOT_TOKEN Ð½Ðµ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½"
    exit 1
fi

# Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ Ð½ÐµÐ¾Ð±Ñ…Ð¾Ð´Ð¸Ð¼Ñ‹Ñ… Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸Ð¹
echo "ðŸ“ Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸Ð¹..."
mkdir -p data logs charts

# ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Python
echo "ðŸ ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð²ÐµÑ€ÑÐ¸Ð¸ Python..."
python3 --version

# Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚ÐµÐ¹
echo "ðŸ“¦ Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚ÐµÐ¹..."
pip3 install -r requirements.txt

# Ð˜Ð½Ð¸Ñ†Ð¸Ð°Ð»Ð¸Ð·Ð°Ñ†Ð¸Ñ Ð±Ð°Ð·Ñ‹ Ð´Ð°Ð½Ð½Ñ‹Ñ…
echo "ðŸ—„ï¸ Ð˜Ð½Ð¸Ñ†Ð¸Ð°Ð»Ð¸Ð·Ð°Ñ†Ð¸Ñ Ð±Ð°Ð·Ñ‹ Ð´Ð°Ð½Ð½Ñ‹Ñ…..."
python3 -c "from database import init_db; init_db()"

# Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ service Ñ„Ð°Ð¹Ð»Ð° Ð´Ð»Ñ systemd
echo "ðŸ”§ Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ systemd service..."
cat > /etc/systemd/system/trading-bot.service << EOF
[Unit]
Description=Telegram Trading Game Bot
After=network.target

[Service]
Type=simple
User=$USER
WorkingDirectory=$(pwd)
Environment="BOT_TOKEN=$BOT_TOKEN"
Environment="ADMIN_IDS=$ADMIN_IDS"
ExecStart=/usr/bin/python3 $(pwd)/bot.py
Restart=always
RestartSec=10
StandardOutput=append:$(pwd)/logs/bot.log
StandardError=append:$(pwd)/logs/bot_error.log

[Install]
WantedBy=multi-user.target
EOF

# ÐŸÐµÑ€ÐµÐ·Ð°Ð³Ñ€ÑƒÐ·ÐºÐ° systemd Ð¸ Ð·Ð°Ð¿ÑƒÑÐº ÑÐµÑ€Ð²Ð¸ÑÐ°
echo "âš¡ Ð—Ð°Ð¿ÑƒÑÐº ÑÐµÑ€Ð²Ð¸ÑÐ°..."
sudo systemctl daemon-reload
sudo systemctl enable trading-bot
sudo systemctl start trading-bot

echo "âœ… Ð Ð°Ð·Ð²ÐµÑ€Ñ‚Ñ‹Ð²Ð°Ð½Ð¸Ðµ Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð¾!"
echo ""
echo "ðŸ“Š ÐŸÐ¾Ð»ÐµÐ·Ð½Ñ‹Ðµ ÐºÐ¾Ð¼Ð°Ð½Ð´Ñ‹:"
echo "â€¢ ÐŸÑ€Ð¾ÑÐ¼Ð¾Ñ‚Ñ€ Ð»Ð¾Ð³Ð¾Ð²: sudo journalctl -u trading-bot -f"
echo "â€¢ ÐŸÐµÑ€ÐµÐ·Ð°Ð¿ÑƒÑÐº Ð±Ð¾Ñ‚Ð°: sudo systemctl restart trading-bot"
echo "â€¢ Ð¡Ñ‚Ð°Ñ‚ÑƒÑ Ð±Ð¾Ñ‚Ð°: sudo systemctl status trading-bot"
echo ""
echo "ðŸŽ® Ð‘Ð¾Ñ‚ Ð·Ð°Ð¿ÑƒÑ‰ÐµÐ½! Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐ¹Ñ‚Ðµ /start Ð² Telegram"
